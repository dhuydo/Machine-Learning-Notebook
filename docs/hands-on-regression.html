<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nguyen Cao Duc Huy">

<title>Machine Learning Notebook - 5&nbsp; Hands-on regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./classification.html" rel="next">
<link href="./gradient-descent.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./hands-on-regression.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Hands-on regression</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/cover.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Machine Learning Notebook</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./landscape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Machine Learning Landscape</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project-checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Machine Learning Project Workflow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gradient-descent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Gradient Descent</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hands-on-regression.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Hands-on regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hands-on-classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Hands-on Classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./svm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Support Vector Machine</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./decision-tree.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Decision Tree</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dimensionality-reduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Dimensionality Reduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ensemble-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Ensemble Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./unsupervised-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Unsupervised Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendix</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Metrics and scoring</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#datasets" id="toc-datasets" class="nav-link active" data-scroll-target="#datasets"><span class="header-section-number">5.1</span> Datasets</a></li>
  <li><a href="#look-at-the-big-picture" id="toc-look-at-the-big-picture" class="nav-link" data-scroll-target="#look-at-the-big-picture"><span class="header-section-number">5.2</span> Look at the big picture</a></li>
  <li><a href="#get-the-data" id="toc-get-the-data" class="nav-link" data-scroll-target="#get-the-data"><span class="header-section-number">5.3</span> Get the Data</a>
  <ul class="collapse">
  <li><a href="#download-data" id="toc-download-data" class="nav-link" data-scroll-target="#download-data"><span class="header-section-number">5.3.1</span> Download Data</a></li>
  <li><a href="#quick-look-to-data-structure-head-info-describe-value_counts-histplot" id="toc-quick-look-to-data-structure-head-info-describe-value_counts-histplot" class="nav-link" data-scroll-target="#quick-look-to-data-structure-head-info-describe-value_counts-histplot"><span class="header-section-number">5.3.2</span> Quick Look to Data Structure: head(), info(), describe(), value_counts(), histplot()</a></li>
  <li><a href="#create-train-val-and-test-set-train_test_split" id="toc-create-train-val-and-test-set-train_test_split" class="nav-link" data-scroll-target="#create-train-val-and-test-set-train_test_split"><span class="header-section-number">5.3.3</span> Create train, val and test set: train_test_split()</a></li>
  </ul></li>
  <li><a href="#explore-and-visualize-the-data-to-gain-insights" id="toc-explore-and-visualize-the-data-to-gain-insights" class="nav-link" data-scroll-target="#explore-and-visualize-the-data-to-gain-insights"><span class="header-section-number">5.4</span> Explore and visualize the data to gain insights</a>
  <ul class="collapse">
  <li><a href="#visualize" id="toc-visualize" class="nav-link" data-scroll-target="#visualize"><span class="header-section-number">5.4.1</span> Visualize</a></li>
  <li><a href="#attributes-combination" id="toc-attributes-combination" class="nav-link" data-scroll-target="#attributes-combination"><span class="header-section-number">5.4.2</span> Attributes combination</a></li>
  </ul></li>
  <li><a href="#explore-and-visualize-data" id="toc-explore-and-visualize-data" class="nav-link" data-scroll-target="#explore-and-visualize-data"><span class="header-section-number">5.5</span> Explore and Visualize Data</a></li>
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data"><span class="header-section-number">5.6</span> Prepare Data</a>
  <ul class="collapse">
  <li><a href="#clean-data" id="toc-clean-data" class="nav-link" data-scroll-target="#clean-data"><span class="header-section-number">5.6.1</span> Clean Data</a></li>
  <li><a href="#handling-text-and-categorical-attributes" id="toc-handling-text-and-categorical-attributes" class="nav-link" data-scroll-target="#handling-text-and-categorical-attributes"><span class="header-section-number">5.6.2</span> Handling Text and Categorical Attributes</a></li>
  <li><a href="#feature-scaling-and-tranformations" id="toc-feature-scaling-and-tranformations" class="nav-link" data-scroll-target="#feature-scaling-and-tranformations"><span class="header-section-number">5.6.3</span> Feature Scaling and Tranformations</a></li>
  <li><a href="#custom-transformers" id="toc-custom-transformers" class="nav-link" data-scroll-target="#custom-transformers"><span class="header-section-number">5.6.4</span> Custom Transformers</a></li>
  <li><a href="#transformation-pipelines" id="toc-transformation-pipelines" class="nav-link" data-scroll-target="#transformation-pipelines"><span class="header-section-number">5.6.5</span> Transformation Pipelines</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-regression" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Hands-on regression</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Main Steps
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Look at the big picture.</li>
<li>Get the data.</li>
<li>Explore and visualize the data to gain insights.</li>
<li>Prepare the data for machine learning algorithms.</li>
<li>Select a model and train it.</li>
<li>Fine-tune model.</li>
<li>Present solution.</li>
<li>Launch, monitor, and maintain system.</li>
</ol>
</div>
</div>
</div>
<section id="datasets" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="datasets"><span class="header-section-number">5.1</span> Datasets</h2>
<p><strong>Popular open data repositories</strong></p>
<ul>
<li>https://openml.org/<br>
</li>
<li>https://Kaggle.com</li>
<li>https://PapersWithCode.com<br>
</li>
<li><a href="https://archive.ics.uci.edu/">UC Irvine Machine Learning Repository — Amazon’s AWS datasets</a></li>
<li><a href="https://www.tensorflow.org/datasets?hl=vi">TensorFlow datasets</a></li>
</ul>
<p><strong>Meta portals (they list open data repositories)</strong></p>
<ul>
<li>https://DataPortals.org<br>
</li>
<li>https://OpenDataMonitor.eu</li>
</ul>
<p><strong>Other pages listing many popular open data repositories</strong></p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/-%20List_of_datasets_for_machine-learning_research">Wikipedia’s list of machine learning datasets</a></li>
<li>https://Quora.com</li>
<li><a href="https://www.reddit.com/r/datasets/">The datasets subreddit</a></li>
</ul>
<p>In this chapter we’ll use the California Housing Prices dataset from the StatLib repository. This dataset is based on data from the 1990 California census. It is not exactly recent but it has many qualities for learning.</p>
</section>
<section id="look-at-the-big-picture" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="look-at-the-big-picture"><span class="header-section-number">5.2</span> Look at the big picture</h2>
<p><strong>Questions</strong></p>
<ol type="1">
<li>Business objective? Current solution (if any)?</li>
<li>How to use and benefit from the model?</li>
<li>Data Pipelines?</li>
<li>Determine kind of model</li>
<li>Select preformance measures</li>
<li>Check the Assumptions</li>
</ol>
<p><strong>Answers</strong></p>
<ul>
<li>Predict median housing price in any district. The results are used for another ML system for investment analysis. The current solution is to gather up-to-date information about a district, or to estimate manually using complex rules if no information.</li>
<li>The current solution is costly and time-consuming, and it was often off by more than 30%. Therefore, a ML model could be more useful.</li>
<li>Data pipelines: A sequence of data processing components. Pipelines are very common in machine learning systems, since there is a lot of data to manipulate and many data transformations to apply.</li>
<li>This is a regression task (labeled data), batch learning (data is quite small and do not change too much) and model-based learning</li>
<li>Metrics for regression:</li>
</ul>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Expand to learn more about metrics
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Both the RMSE and the MAE are ways to measure the distance between two vectors: the vector of predictions and the vector of target values. Various distance measures, or norms, are possible:<br>
- Computing the root of a sum of squares (RMSE) corresponds to the Euclidean norm: this is the notion of distance we are all familiar with. It is also called the l2 norm, noted |·|₂ (or just |·|).<br>
- Computing the sum of absolutes (MAE) corresponds to the l1 norm, noted |·|₁. This is sometimes called the Manhattan norm because it measures the distance between two points in a city if you can only travel along orthogonal city blocks.<br>
- More generally, the lk norm of a vector v containing n elements is defined as ∥v∥k = (|v₁|ᵏ + |v₂|ᵏ + … + |vₙ|ᵏ)¹/ᵏ. l0 gives the number of nonzero elements in the vector, and l∞ gives the maximum absolute value in the vector.<br>
The higher the norm index, the more it focuses on large values and neglects small ones. This is why the RMSE is more sensitive to outliers than the MAE. But when outliers are exponentially rare (like in a bell-shaped curve), the RMSE performs very well and is generally preferred. <img src="images/l1_l2.png" id="fig-l1-l2" class="img-fluid" alt="L1 norm and L2 norm"></p>
</div>
</div>
</div>
<p>RMSE (root mean squared error): l2 norm<br>
<span class="math display">\[
RMSE(X, y)  = \sqrt{\frac{1}{m}\sum_{i=1}^{m}(y_{hat}^{(i)} - y^{(i)})^2}
\]</span></p>
<p>MAE (mean squared error): l1 norm<br>
<span class="math display">\[
MAE(X, y)  = \frac{1}{m}\sum_{i=1}^{m}|y_{hat}^{(i)} - y^{(i)}|
\]</span></p>
<ul>
<li>Check with the team in charge of the downstream system that use out output whether it is suitable or not (e.g.&nbsp;it is terrible if after several months building model you realize that they need ordinal output not numerical one)</li>
</ul>
</section>
<section id="get-the-data" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="get-the-data"><span class="header-section-number">5.3</span> Get the Data</h2>
<section id="download-data" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="download-data"><span class="header-section-number">5.3.1</span> Download Data</h3>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Load data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(url):</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> Path(<span class="st">"datasets/housing.tgz"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> path.is_file():</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        Path(<span class="st">"datasets"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        urllib.request.urlretrieve(url, path)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        tarfile.<span class="bu">open</span>(path).extractall(path<span class="op">=</span><span class="st">'datasets'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(<span class="st">'datasets/housing/housing.csv'</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://github.com/ageron/data/raw/main/housing.tgz'</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> load_data(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="quick-look-to-data-structure-head-info-describe-value_counts-histplot" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="quick-look-to-data-structure-head-info-describe-value_counts-histplot"><span class="header-section-number">5.3.2</span> Quick Look to Data Structure: head(), info(), describe(), value_counts(), histplot()</h3>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Quick look</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)      <span class="co"># display all columns</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">housing_median_age</th>
<th data-quarto-table-cell-role="th">total_rooms</th>
<th data-quarto-table-cell-role="th">total_bedrooms</th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">households</th>
<th data-quarto-table-cell-role="th">median_income</th>
<th data-quarto-table-cell-role="th">median_house_value</th>
<th data-quarto-table-cell-role="th">ocean_proximity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-122.23</td>
<td>37.88</td>
<td>41.0</td>
<td>880.0</td>
<td>129.0</td>
<td>322.0</td>
<td>126.0</td>
<td>8.3252</td>
<td>452600.0</td>
<td>NEAR BAY</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-122.22</td>
<td>37.86</td>
<td>21.0</td>
<td>7099.0</td>
<td>1106.0</td>
<td>2401.0</td>
<td>1138.0</td>
<td>8.3014</td>
<td>358500.0</td>
<td>NEAR BAY</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-122.24</td>
<td>37.85</td>
<td>52.0</td>
<td>1467.0</td>
<td>190.0</td>
<td>496.0</td>
<td>177.0</td>
<td>7.2574</td>
<td>352100.0</td>
<td>NEAR BAY</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-122.25</td>
<td>37.85</td>
<td>52.0</td>
<td>1274.0</td>
<td>235.0</td>
<td>558.0</td>
<td>219.0</td>
<td>5.6431</td>
<td>341300.0</td>
<td>NEAR BAY</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-122.25</td>
<td>37.85</td>
<td>52.0</td>
<td>1627.0</td>
<td>280.0</td>
<td>565.0</td>
<td>259.0</td>
<td>3.8462</td>
<td>342200.0</td>
<td>NEAR BAY</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>There are total 10 features, each row represents a district observation</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 20640 entries, 0 to 20639
Data columns (total 10 columns):
 #   Column              Non-Null Count  Dtype  
---  ------              --------------  -----  
 0   longitude           20640 non-null  float64
 1   latitude            20640 non-null  float64
 2   housing_median_age  20640 non-null  float64
 3   total_rooms         20640 non-null  float64
 4   total_bedrooms      20433 non-null  float64
 5   population          20640 non-null  float64
 6   households          20640 non-null  float64
 7   median_income       20640 non-null  float64
 8   median_house_value  20640 non-null  float64
 9   ocean_proximity     20640 non-null  object 
dtypes: float64(9), object(1)
memory usage: 1.6+ MB</code></pre>
</div>
</div>
<p>Data with 10 columns and 20640 rows 9 numerical features, 1 categorical feature ‘total_bedrooms’ has only 20433 non-null values</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data.describe(include<span class="op">=</span><span class="st">'all'</span>)        <span class="co"># describe all type of data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">housing_median_age</th>
<th data-quarto-table-cell-role="th">total_rooms</th>
<th data-quarto-table-cell-role="th">total_bedrooms</th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">households</th>
<th data-quarto-table-cell-role="th">median_income</th>
<th data-quarto-table-cell-role="th">median_house_value</th>
<th data-quarto-table-cell-role="th">ocean_proximity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>20640.000000</td>
<td>20640.000000</td>
<td>20640.000000</td>
<td>20640.000000</td>
<td>20433.000000</td>
<td>20640.000000</td>
<td>20640.000000</td>
<td>20640.000000</td>
<td>20640.000000</td>
<td>20640</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>&lt;1H OCEAN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>9136</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>-119.569704</td>
<td>35.631861</td>
<td>28.639486</td>
<td>2635.763081</td>
<td>537.870553</td>
<td>1425.476744</td>
<td>499.539680</td>
<td>3.870671</td>
<td>206855.816909</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>2.003532</td>
<td>2.135952</td>
<td>12.585558</td>
<td>2181.615252</td>
<td>421.385070</td>
<td>1132.462122</td>
<td>382.329753</td>
<td>1.899822</td>
<td>115395.615874</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>-124.350000</td>
<td>32.540000</td>
<td>1.000000</td>
<td>2.000000</td>
<td>1.000000</td>
<td>3.000000</td>
<td>1.000000</td>
<td>0.499900</td>
<td>14999.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>-121.800000</td>
<td>33.930000</td>
<td>18.000000</td>
<td>1447.750000</td>
<td>296.000000</td>
<td>787.000000</td>
<td>280.000000</td>
<td>2.563400</td>
<td>119600.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>-118.490000</td>
<td>34.260000</td>
<td>29.000000</td>
<td>2127.000000</td>
<td>435.000000</td>
<td>1166.000000</td>
<td>409.000000</td>
<td>3.534800</td>
<td>179700.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>-118.010000</td>
<td>37.710000</td>
<td>37.000000</td>
<td>3148.000000</td>
<td>647.000000</td>
<td>1725.000000</td>
<td>605.000000</td>
<td>4.743250</td>
<td>264725.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>-114.310000</td>
<td>41.950000</td>
<td>52.000000</td>
<td>39320.000000</td>
<td>6445.000000</td>
<td>35682.000000</td>
<td>6082.000000</td>
<td>15.000100</td>
<td>500001.000000</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ft <span class="kw">in</span> data.select_dtypes(<span class="st">'object'</span>):     <span class="co"># choose 'object' features only</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(data[ft].value_counts())</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Number of classes: </span><span class="sc">{</span>data[ft]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ocean_proximity
&lt;1H OCEAN     9136
INLAND        6551
NEAR OCEAN    2658
NEAR BAY      2290
ISLAND           5
Name: count, dtype: int64
Number of classes: 5</code></pre>
</div>
</div>
<p>Quite imbalanced classes</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Plot histogram of numerical features</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>data.hist(bins<span class="op">=</span><span class="dv">50</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="hands-on-regression_files/figure-html/cell-7-output-1.png" width="660" height="653"></p>
</div>
</div>
<p><em>housing_median_age</em>: capped at range (1,52)<br>
<em>median_income</em>: scaled and capped at range ~ (0.5, 15)<br>
<em>median_house_value</em>: capped at top range of 500,000<br>
These features are <code>skewed</code> and have very <code>different scales</code> =&gt; Transforming and Feature Scaling</p>
</section>
<section id="create-train-val-and-test-set-train_test_split" class="level3" data-number="5.3.3">
<h3 data-number="5.3.3" class="anchored" data-anchor-id="create-train-val-and-test-set-train_test_split"><span class="header-section-number">5.3.3</span> Create train, val and test set: train_test_split()</h3>
<p><code>random sampling</code>: data must be large enough, otherwise there is a risk of sampling bias <code>stratified sampling</code>: based on some very important features, help avoid <em>bias</em> and ensure train set and test set are <em>representative</em> to full dataset</p>
<p><em>Here we assump that median_income is very important feature to predict household value</em></p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Create new feature (income group)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'income_grp'</span>] <span class="op">=</span> pd.cut(data[<span class="st">'median_income'</span>], bins<span class="op">=</span>[<span class="dv">0</span>,<span class="fl">1.5</span>,<span class="dv">3</span>,<span class="fl">4.5</span>,<span class="dv">6</span>,np.inf], labels<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>])</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>data.income_grp.value_counts().sort_index().plot.bar(rot<span class="op">=</span><span class="dv">0</span>, grid<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Frequency of income group'</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Income group'</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="hands-on-regression_files/figure-html/cell-8-output-1.png" width="602" height="449"></p>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Split data into train, val, test set</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>x_train, x_test, y_train, y_test <span class="op">=</span> train_test_split(data.drop(<span class="st">'median_house_value'</span>, axis<span class="op">=</span><span class="dv">1</span>), data.median_house_value, stratify<span class="op">=</span>data[<span class="st">'income_grp'</span>], test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">24</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Drop the 'income_grp' after using</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [x_train, x_test]:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    df.drop(<span class="st">'income_grp'</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="explore-and-visualize-the-data-to-gain-insights" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="explore-and-visualize-the-data-to-gain-insights"><span class="header-section-number">5.4</span> Explore and visualize the data to gain insights</h2>
<p>If the data is very large, we will sample an exploration set to manipulate faster and easier. On the other hand, just work directly on full set if the data is quite small.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_vis <span class="op">=</span> data.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="visualize" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="visualize"><span class="header-section-number">5.4.1</span> Visualize</h3>
<p><strong>Plot</strong></p>
<div class="cell" data-fig-width="2" data-execution_count="11">
<div class="cell-output cell-output-display">
<div id="fig-geoplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="hands-on-regression_files/figure-html/fig-geoplot-output-1.png" width="544" height="508" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5.1: The geographical plot of data</figcaption>
</figure>
</div>
</div>
</div>
<p>Large point size: larger population Blue -&gt; red: higher house price</p>
<p><strong>Correlation</strong></p>
<p>There are 2 ways to perform: heatmap and pairgrid map</p>
<div id="fig-corr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="fig-corr-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<pre><code>&lt;Axes: &gt;</code></pre>
<figcaption class="figure-caption">(a) Correlation Plot</figcaption>
</figure>
</div>
<div class="cell-output cell-output-display">
<div id="fig-corr-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="hands-on-regression_files/figure-html/fig-corr-output-2.png" data-ref-parent="fig-corr" width="681" height="544" class="figure-img"></p>
<figcaption class="figure-caption">(b)</figcaption>
</figure>
</div>
</div>
<figcaption class="figure-caption">Figure&nbsp;5.2: <strong>?(caption)</strong></figcaption>
</figure>
</div>
<div class="cell" data-fig-width="1" data-execution_count="13">
<div class="cell-output cell-output-display">
<div id="fig-pairgrid" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="hands-on-regression_files/figure-html/fig-pairgrid-output-1.png" width="962" height="938" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5.3: PairGrid Plot of numerical features</figcaption>
</figure>
</div>
</div>
</div>
<p><em>Try pd.plotting.scatter_matrix</em></p>
<p>Look closely too the relation between ‘median_house_value’ and ‘median_income’, we see there is a strong positive correlation, but there are some clearly horizontal line at 500,000; 450,000; 350,000 and roughly 280,000. We should remove these instances to prevent the algorithms learning these patterns.</p>
<div class="cell" data-execution_count="14">
<div class="cell-output cell-output-display">
<div id="fig-corr2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="hands-on-regression_files/figure-html/fig-corr2-output-1.png" width="696" height="509" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5.4: Median income versus median house value</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="attributes-combination" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="attributes-combination"><span class="header-section-number">5.4.2</span> Attributes combination</h3>
<p>Useful when we want to find better features to predict</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_vis[<span class="st">'room_per_house'</span>] <span class="op">=</span> df_vis[<span class="st">'total_rooms'</span>]<span class="op">/</span>df_vis[<span class="st">'households'</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df_vis[<span class="st">'bedroom_ratio'</span>] <span class="op">=</span> df_vis[<span class="st">'total_bedrooms'</span>]<span class="op">/</span>df_vis[<span class="st">'total_rooms'</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>df_vis[<span class="st">'people_per_house'</span>] <span class="op">=</span> df_vis[<span class="st">'population'</span>]<span class="op">/</span>df_vis[<span class="st">'households'</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> df_vis.corr(numeric_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="st">'median_house_value'</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>median_house_value    1.000000
median_income         0.688075
room_per_house        0.151948
total_rooms           0.134153
housing_median_age    0.105623
households            0.065843
total_bedrooms        0.049686
people_per_house     -0.023737
population           -0.024650
longitude            -0.045967
latitude             -0.144160
bedroom_ratio        -0.255880
Name: median_house_value, dtype: float64</code></pre>
</div>
</div>
</section>
</section>
<section id="explore-and-visualize-data" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="explore-and-visualize-data"><span class="header-section-number">5.5</span> Explore and Visualize Data</h2>
<ul>
<li>Visualize</li>
<li>Compute correlation (corr_matrix(), pandas.plotting.scatter_matrix() )</li>
<li>Attributes combination</li>
</ul>
</section>
<section id="prepare-data" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="prepare-data"><span class="header-section-number">5.6</span> Prepare Data</h2>
<p>Benefits: - Reproduce tranformations easily - Build library of tranformations for future projects - Use in live system to transform new data - Try various transformations =&gt; Choose best combination of transformations</p>
<section id="clean-data" class="level3" data-number="5.6.1">
<h3 data-number="5.6.1" class="anchored" data-anchor-id="clean-data"><span class="header-section-number">5.6.1</span> Clean Data</h3>
<p>Missing Values: - Get rid of them - Get rid of whole attributes - Set new values (imputation): zero, mean, median, most_frequent, constant, etc. - sklearn.impute.SimpleImputer() - Apply to all numerical variables cause we do not know there will not be any missing values in the future. - More powerful imputer: KnnImputer(), IterativeImputer()</p>
</section>
<section id="handling-text-and-categorical-attributes" class="level3" data-number="5.6.2">
<h3 data-number="5.6.2" class="anchored" data-anchor-id="handling-text-and-categorical-attributes"><span class="header-section-number">5.6.2</span> Handling Text and Categorical Attributes</h3>
<ul>
<li>OneHotEncoder, LabelEncoder, OrdinalEncoder
<ul>
<li>default: Scipy sparse matrix =&gt; set sparse=False or toarray()</li>
<li>pandas.get_dummies(): generate new columns for unknown categories</li>
<li>OneHotEncoder: detect unknown categories</li>
</ul></li>
<li>If a categorical attribute has a large number of possible categories =&gt; OneHotEncoder will be result in a large number of input features
<ul>
<li>Turn categorical -&gt; numerical category</li>
<li>In <em>neural networks</em>: replace each category -&gt; <em>embedding</em> (a learnable, low-dimensional vector)</li>
</ul></li>
</ul>
</section>
<section id="feature-scaling-and-tranformations" class="level3" data-number="5.6.3">
<h3 data-number="5.6.3" class="anchored" data-anchor-id="feature-scaling-and-tranformations"><span class="header-section-number">5.6.3</span> Feature Scaling and Tranformations</h3>
<section id="for-input-attributes" class="level4" data-number="5.6.3.1">
<h4 data-number="5.6.3.1" class="anchored" data-anchor-id="for-input-attributes"><span class="header-section-number">5.6.3.1</span> For input attributes</h4>
<ul>
<li>Some ML algorithms don’t perform well when the input numerical attributes have very different scales.</li>
<li>Without any scaling, most models will be biased toward ignoring the small values and focusing more on the larger values.</li>
</ul>
<p>Two common feature scaling techniques: <em>min-max scaling</em> and <em>standardization</em> - Use <em>fit</em> or <em>fit_transform</em> only on <strong>training set</strong> - <strong>Training set</strong> will always be scaled to specific range, if new data contains outliers, these may end up scaled outside the range =&gt; Set clip hyperparameter to <em>True</em> to avoid.</p>
<ul>
<li><p><strong>Min-max scaling (normalization)</strong>:</p></li>
<li><p>Default range: 0-1</p></li>
<li><p>MinMaxScaler(feature_range=(-1,1)): change the prefered range</p></li>
<li><p><strong>Standardization</strong>:</p></li>
<li><p>Less affected by outliers</p></li>
<li><p>StandardScaler(with_mean=False): only divide the data by the standard deviation, without subtracting the mean =&gt; scale sparse matrix without converting to dense matrix</p></li>
<li><p><em>Heavy-tailed attributes</em>:</p></li>
<li><p>Both min-max scaling and standardization will squash most values into a small range</p></li>
<li><p>Solutions: square root (or power 0-1), logarithm, bucketizing</p>
<ul>
<li>bucketizing: chop its distribution into equal-sized buckets =&gt; replace with the index (i.e.&nbsp;<em>percentile</em>, <em>categories (for multimodal distribution)</em>) of buckets.
<ul>
<li><em>multimodal distribution</em>: 2 or more clear peaks (also called mode).</li>
</ul></li>
<li>other options for <em>multimodal distribution</em>: Gaussian radial basic function (RBF) measure the similarity between that attribute and the modes.</li>
</ul></li>
</ul>
</section>
<section id="for-output" class="level4" data-number="5.6.3.2">
<h4 data-number="5.6.3.2" class="anchored" data-anchor-id="for-output"><span class="header-section-number">5.6.3.2</span> For output</h4>
<p>After feature scaling the target values to make predictions on new data, it has to be <em>inverse_transform()</em>, or just do TransformedTargetRegressor.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> TransformedTargetRegressor</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> TransformedTargetRegressor(LinearRegression(),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                                       transformer<span class="op">=</span>StandardScaler())</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.fit(housing[["median_income"]], housing_labels)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># predictions = model.predict(some_new_data)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="custom-transformers" class="level3" data-number="5.6.4">
<h3 data-number="5.6.4" class="anchored" data-anchor-id="custom-transformers"><span class="header-section-number">5.6.4</span> Custom Transformers</h3>
<p>Write own custom transformers: custom transformations, cleanup operations, or combining specific attributes.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> FunctionTransformer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><em>For details, check p.79, 80, 81</em></strong></p>
<ul>
<li>A transformer should contains:
<ul>
<li>fit(): self.n_features_in_ , return <em>self</em></li>
<li>get_feature_names_out() =&gt; to create DataFrame after <em>transform</em></li>
<li>inverse_transform()</li>
</ul></li>
<li>This is a custom transformer using <em>KMeans clusterer</em> in the fit() method to identify the main clusters in the training data, and then uses <em>rbf_kernel()</em> in the transform() method to measure how similar each sample is to each cluster center:</li>
</ul>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ClusterSimilarity(BaseEstimator, TransformerMixin):  </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_clusters<span class="op">=</span><span class="dv">10</span>, gamma<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_clusters <span class="op">=</span> n_clusters</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gamma <span class="op">=</span> gamma</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.random_state <span class="op">=</span> random_state</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>, sample_weight<span class="op">=</span><span class="va">None</span>):  </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kmeans_ <span class="op">=</span> KMeans(<span class="va">self</span>.n_clusters, random_state<span class="op">=</span><span class="va">self</span>.random_state) </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kmeans_.fit(X, sample_weight<span class="op">=</span>sample_weight)  </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span> <span class="co"># always return self!</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):  </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rbf_kernel(X, <span class="va">self</span>.kmeans_.cluster_centers_, gamma<span class="op">=</span><span class="va">self</span>.gamma)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_feature_names_out(<span class="va">self</span>, names<span class="op">=</span><span class="va">None</span>):  </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="ss">f"Cluster </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> similarity"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n_clusters)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><em>For details, check p.82</em></strong></p>
<ul>
<li>You can check whether your custom estimator respects <em>Scikit-Learn’s API</em> by passing an instance to check_estimator() from the sklearn.utils.estimator_checks package. For the full API, check out https://scikit-learn.org/stable/developers.</li>
</ul>
</section>
<section id="transformation-pipelines" class="level3" data-number="5.6.5">
<h3 data-number="5.6.5" class="anchored" data-anchor-id="transformation-pipelines"><span class="header-section-number">5.6.5</span> Transformation Pipelines</h3>
<ul>
<li><p><strong>Pipeline</strong>: sequence of transformations =&gt; Take list of names/estimators</p>
<ul>
<li>Names must be <em>unique</em> and do not contain <em>double underscores</em></li>
<li>First (n-1) names: <em>transformers</em> Last name: regardless <em>transformer</em> or <em>predictor</em></li>
</ul></li>
</ul>
<p>2 ways:</p>
<p><strong>Pipeline</strong></p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>num_pipeline <span class="op">=</span> Pipeline([</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"impute"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"standardize"</span>, StandardScaler()),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>make_pipeline</strong> (don’t care naming estimators)</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline  </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>num_pipeline <span class="op">=</span> make_pipeline(SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>), StandardScaler())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>The pipeline exposes the same methods as the <em>final estimator</em> (transformer or predictor)</p></li>
<li><p>In a Jupyter notebook, if we import sklearn and run sklearn.set_config(display=“diagram”), all Scikit-Learn estimators will be rendered as interactive diagrams. This is particularly useful for visualizing pipelines. To visualize <em>num_pipeline</em>, run a cell with num_pipeline as the last line. Clicking an estimator will show more details.</p></li>
<li><p>2 ways to apply transform for numerical attributes and categorical attributes <em>seperately</em>:</p></li>
</ul>
<p><strong>ColumnTransformer</strong>:</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline, make_pipeline</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, OneHotEncoder</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>num_attribs <span class="op">=</span> [<span class="st">"longitude"</span>, <span class="st">"latitude"</span>, <span class="st">"housing_median_age"</span>, <span class="st">"total_rooms"</span>, <span class="st">"total_bedrooms"</span>, <span class="st">"population"</span>, <span class="st">"households"</span>, <span class="st">"median_income"</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>cat_attribs <span class="op">=</span> [<span class="st">"ocean_proximity"</span>]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>num_pipeline <span class="op">=</span> Pipeline([</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"impute"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"standardize"</span>, StandardScaler()),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>cat_pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>),</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">"ignore"</span>))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>preprocessing <span class="op">=</span> ColumnTransformer([</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"num"</span>, num_pipeline, num_attribs),</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"cat"</span>, cat_pipeline, cat_attribs),</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>make_column_selector</strong>, <strong>make_column_transformer</strong> (don’t care naming estimators)</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> make_column_selector, make_column_transformer</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>preprocessing <span class="op">=</span> make_column_transformer(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    (num_pipeline, make_column_selector(dtype_include<span class="op">=</span>np.number)),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    (cat_pipeline, make_column_selector(dtype_include<span class="op">=</span><span class="bu">object</span>)),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>Drop or passthrough columns: *<strong>For details, see p.86</strong></p></li>
<li><p><strong>Recap Pipeline</strong></p></li>
<li><p>Missing values in numerical features will be imputed by replacing them with the median, as most ML algorithms don’t expect missing values. In categorical features, missing values will be replaced by the most frequent category.</p></li>
<li><p>The categorical feature will be one-hot encoded, as most ML algorithms only accept numerical inputs.</p></li>
<li><p>A few ratio features will be computed and added: bedrooms_ratio, rooms_per_house, and people_per_house. Hopefully these will better correlate with the median house value, and thereby help the ML models.</p></li>
<li><p>A few cluster similarity features will also be added. These will likely be more useful to the model than latitude and longitude.</p></li>
<li><p>Features with a long tail will be replaced by their logarithm, as most models prefer features with roughly uniform or Gaussian distributions.</p></li>
<li><p>All numerical features will be standardized, as most ML algorithms prefer when all features have roughly the same scale.</p></li>
</ul>
<p><strong>Final Pipeline</strong>:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> column_ratio(X):  </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X[:, [<span class="dv">0</span>]] <span class="op">/</span> X[:, [<span class="dv">1</span>]]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ratio_name(function_transformer, feature_names_in): </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">"ratio"</span>] <span class="co">#feature names out</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ratio_pipeline(): </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_pipeline(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        FunctionTransformer(column_ratio, feature_names_out<span class="op">=</span>ratio_name),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        StandardScaler())</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>log_pipeline <span class="op">=</span> make_pipeline(</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    FunctionTransformer(np.log, feature_names_out<span class="op">=</span><span class="st">"one-to-one"</span>),</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    StandardScaler())</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>cluster_simil <span class="op">=</span> ClusterSimilarity(n_clusters<span class="op">=</span><span class="dv">10</span>, gamma<span class="op">=</span><span class="fl">1.</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>default_num_pipeline <span class="op">=</span> make_pipeline(SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>),</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        StandardScaler())</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>preprocessing <span class="op">=</span> ColumnTransformer([</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"bedrooms"</span>, ratio_pipeline(), [<span class="st">"total_bedrooms"</span>, <span class="st">"total_rooms"</span>]),</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"rooms_per_house"</span>, ratio_pipeline(), [<span class="st">"total_rooms"</span>, <span class="st">"households"</span>]),</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"people_per_house"</span>, ratio_pipeline(), [<span class="st">"population"</span>, <span class="st">"households"</span>]),</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"log"</span>, log_pipeline, [<span class="st">"total_bedrooms"</span>, <span class="st">"total_rooms"</span>, <span class="st">"population"</span>,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"households"</span>, <span class="st">"median_income"</span>]),</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"geo"</span>, cluster_simil, [<span class="st">"latitude"</span>, <span class="st">"longitude"</span>]),</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"cat"</span>, cat_pipeline, make_column_selector(dtype_include<span class="op">=</span><span class="bu">object</span>)),</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    remainder<span class="op">=</span>default_num_pipeline) <span class="co"># one column remaining: housing_median_age</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./gradient-descent.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Gradient Descent</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./classification.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Classification</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Machine Learning Notebook was written by Nguyen Cao Duc Huy</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>